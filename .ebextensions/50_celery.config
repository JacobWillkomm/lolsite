files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/run_supervised_celeryd.sh" :
    mode: "000755"
    owner: root
    group: root
    content: |
      celeryenv=`cat /opt/python/current/env | tr '\n' ',' | sed 's/export //g' | sed 's/$PYTHONPATH//g' | sed 's/$LD_LIBRARY_PATH//g'`
      celeryenv=${celeryenv%?}
      celeryconf="[program:celeryd-worker]
      command=/opt/python/run/venv/bin/celery worker -A lolsite --loglevel=INFO -n \"worker-$HOSTNAME\"
      directory=/opt/python/current/app  
      user=nobody
      numprocs=1
      stdout_logfile=/var/log/celery-worker-$HOSTNAME.log  
      stderr_logfile=/var/log/celery-worker-$HOSTNAME.log 
      autostart=true
      autorestart=true
      startsecs=10
      stopwaitsecs = 600
      killasgroup=true
      priority=998
      environment=$celeryenv" 
      supervisorctl -c /opt/python/etc/supervisord.conf reread
      supervisorctl -c /opt/python/etc/supervisord.conf update
      supervisorctl -c /opt/python/etc/supervisord.conf restart celeryd-worker

container_commands:
  06_celery_tasks_run:
    command: "/opt/elasticbeanstalk/hooks/appdeploy/post/run_supervised_celeryd.sh"

option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: lolsite/wsgi.py
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: "lolsite.settings"
